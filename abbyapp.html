<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <title>Speed-Color Map (Prototype)</title>
  <meta name="theme-color" content="#111111">
  <link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:&quot;Speed-Color Map&quot;,&quot;short_name&quot;:&quot;SpeedMap&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#111111&quot;,&quot;theme_color&quot;:&quot;#111111&quot;}">
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    :root { --bg: #0b0b0c; --fg: #f5f5f7; --muted:#a3a3a3; --btn:#222; --btnb:#2c2c2c; --accent:#4ade80; }
    html,body,#app { height: 100%; margin:0; background: var(--bg); color:var(--fg); font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
    #map { position: absolute; inset: 0; }
    #ui { position: fixed; top: env(safe-area-inset-top); left: 0; right: 0; display: flex; gap: 8px; padding: 10px 12px; background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,0)); z-index: 1000; align-items: center; flex-wrap: wrap; }
    .pill { display:inline-flex; align-items:center; gap:8px; border-radius: 999px; background: rgba(17,17,17,.7); padding: 8px 12px; backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,.08); }
    .btn { appearance:none; border:1px solid #333; background:var(--btn); color:var(--fg); border-radius:999px; padding:8px 12px; font-weight:600; }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background:#14532d; border-color:#1f7a47;}
    .btn.warn { background:#7a1f1f; border-color:#a33; }
    .metric { font-variant-numeric: tabular-nums; }
    #legend { position: fixed; bottom: 16px; left: 16px; background: rgba(17,17,17,.7); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px; backdrop-filter: blur(8px); z-index:1000;}
    #legend .row { display:flex; align-items:center; gap:8px; margin:.25rem 0; }
    .swatch { width:18px; height:8px; border-radius:4px; }
    #toast { position: fixed; bottom: 18px; left:50%; transform: translateX(-50%); background:#222; border:1px solid #333; color:#fff; padding:10px 14px; border-radius:12px; display:none; z-index:2000; }
  </style>
</head>
<body>
<div id="app">
  <div id="map"></div>
  <div id="ui">
    <div class="pill">
      <button id="startBtn" class="btn primary">Start</button>
      <button id="stopBtn" class="btn">Stop</button>
      <button id="resetBtn" class="btn warn">Reset</button>
      <button id="exportCsvBtn" class="btn">Export CSV</button>
      <button id="exportGpxBtn" class="btn">Export GPX</button>
    </div>
    <div class="pill">
      <span>Speed:</span>
      <span id="speed" class="metric">—</span>
      <span id="unit">m/s</span>
    </div>
    <div class="pill">
      <label for="unitsSelect">Units</label>
      <select id="unitsSelect" class="btn">
        <option value="mps">m/s</option>
        <option value="kmh">km/h</option>
        <option value="mph">mph</option>
        <option value="kn">kn</option>
      </select>
    </div>
  </div>
  <div id="legend">
    <div><strong>Color scale</strong> (by speed)</div>
    <div class="row"><span class="swatch" style="background:#3b82f6;"></span> <span class="metric">&lt; 2 m/s (walk)</span></div>
    <div class="row"><span class="swatch" style="background:#10b981;"></span> <span class="metric">2–8 m/s (jog/bike)</span></div>
    <div class="row"><span class="swatch" style="background:#f59e0b;"></span> <span class="metric">8–22 m/s (city drive)</span></div>
    <div class="row"><span class="swatch" style="background:#ef4444;"></span> <span class="metric">&gt; 22 m/s (highway/train)</span></div>
  </div>
  <div id="toast"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
(function(){
  const map = L.map('map', { zoomControl: false });
  const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20, attribution: '&copy; OpenStreetMap' });
  tiles.addTo(map);
  L.control.zoom({ position: 'bottomright' }).addTo(map);

  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const resetBtn = document.getElementById('resetBtn');
  const exportCsvBtn = document.getElementById('exportCsvBtn');
  const exportGpxBtn = document.getElementById('exportGpxBtn');
  const speedEl  = document.getElementById('speed');
  const unitEl   = document.getElementById('unit');
  const unitsSel = document.getElementById('unitsSelect');
  const toastEl  = document.getElementById('toast');

  let watchId = null;
  let last = null;
  let points = []; // {t, lat, lon, speed, acc}
  const layerGroup = L.layerGroup().addTo(map);

  function showToast(msg, ms=2000){
    toastEl.textContent = msg;
    toastEl.style.display = 'block';
    setTimeout(()=> toastEl.style.display='none', ms);
  }

  function toRad(d){ return d*Math.PI/180; }
  function haversine(a,b){
    const R=6371000;
    const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon);
    const lat1=toRad(a.lat), lat2=toRad(b.lat);
    const s1=Math.sin(dLat/2), s2=Math.sin(dLon/2);
    return 2*R*Math.asin(Math.sqrt(s1*s1 + Math.cos(lat1)*Math.cos(lat2)*s2*s2));
  }

  function colorForSpeed(v){
    if (v < 2) return '#3b82f6';
    if (v < 8) return '#10b981';
    if (v < 22) return '#f59e0b';
    return '#ef4444';
  }

  function formatSpeed(v, units){
    if (v == null || !isFinite(v)) return '—';
    switch(units){
      case 'kmh': return (v*3.6).toFixed(1);
      case 'mph': return (v*2.236936).toFixed(1);
      case 'kn':  return (v*1.943844).toFixed(1);
      default:    return v.toFixed(1);
    }
  }

  function start(){
    if (!navigator.geolocation) { showToast('Geolocation not supported'); return; }
    if (watchId !== null) return;

    watchId = navigator.geolocation.watchPosition(onPos, onErr, {
      enableHighAccuracy: true,
      maximumAge: 0,
      timeout: 15000
    });
    showToast('Tracking started');
  }

  function stop(){
    if (watchId !== null) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
      showToast('Tracking stopped');
    }
  }

  function reset(){
    stop();
    last = null;
    points = [];
    layerGroup.clearLayers();
    speedEl.textContent = '—';
  }

  function onPos(pos){
    const { latitude, longitude, speed, accuracy } = pos.coords;
    const t = pos.timestamp;
    const curr = {lat: latitude, lon: longitude, t};
    if (!last) {
      map.setView([latitude, longitude], 16);
      last = curr;
      points.push({t, lat: latitude, lon: longitude, speed: Math.max(speed??-1, -1), acc: accuracy});
      return;
    }
    let v = (speed!=null && speed>=0) ? speed : haversine(last, curr) / ((t - last.t)/1000);
    if (!isFinite(v) || v < 0) v = 0;
    speedEl.textContent = formatSpeed(v, unitsSel.value);
    unitEl.textContent  = unitsSel.options[unitsSel.selectedIndex].text;

    const seg = L.polyline([[last.lat,last.lon],[curr.lat,curr.lon]], {color: colorForSpeed(v), weight: 6, opacity: 0.95});
    layerGroup.addLayer(seg);
    last = curr;
    points.push({t, lat: latitude, lon: longitude, speed: v, acc: accuracy});
  }

  function onErr(err){
    console.error(err);
    showToast(err.message || 'Location error');
  }

  function download(filename, content, type='text/plain'){
    const blob = new Blob([content], {type});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  function toCSV(rows){
    const header = ['time_iso','timestamp_ms','lat','lon','speed_mps','accuracy_m'];
    const lines = [header.join(',')];
    for (const p of rows) {
      lines.push([new Date(p.t).toISOString(), p.t, p.lat, p.lon, (p.speed ?? ''), (p.acc ?? '')].join(','));
    }
    return lines.join('\n');
  }

  function toGPX(rows){
    const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const head = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="Speed-Color Map" xmlns="http://www.topografix.com/GPX/1/1" xmlns:gpxtpx="http://www.garmin.com/xmlschemas/TrackPointExtension/v1">
  <trk><name>Speed-Color Track</name><trkseg>`;
    const tail = `  </trkseg></trk></gpx>`;
    const body = rows.map(p => `    <trkpt lat="${p.lat}" lon="${p.lon}">
      <time>${esc(new Date(p.t).toISOString())}</time>
      ${Number.isFinite(p.speed)?`<extensions><gpxtpx:TrackPointExtension><gpxtpx:speed>${p.speed.toFixed(2)}</gpxtpx:speed></gpxtpx:TrackPointExtension></extensions>`:''}
    </trkpt>`).join('\n');
    return [head, body, tail].join('\n');
  }

  startBtn.addEventListener('click', start);
  stopBtn.addEventListener('click', stop);
  resetBtn.addEventListener('click', reset);
  exportCsvBtn.addEventListener('click', ()=> download('track.csv', toCSV(points), 'text/csv'));
  exportGpxBtn.addEventListener('click', ()=> download('track.gpx', toGPX(points), 'application/gpx+xml'));
  unitsSel.addEventListener('change', ()=>{});

  if (navigator.permissions && navigator.permissions.query) {
    navigator.permissions.query({name:'geolocation'}).then(p => {
      if (p.state === 'granted') start();
    }).catch(()=>{});
  }
})();
</script>
</body>
</html>