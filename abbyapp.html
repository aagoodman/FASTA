<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>FASTA</title>
  <meta name="theme-color" content="#1A5EB2" />

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  <link rel="icon" href="./icons/icon-192.png" sizes="192x192">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    :root { --bg:#1A5EB2; --fg:#f5f5f7; --btn:#1b1b1b; --muted:#a3a3a3; }
    html,body,#app { height:100%; margin:0; background:var(--bg); color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    #map { position:absolute; inset:0; }

    /* Locate button styled like zoom */
    .leaflet-control-locate {
      display:flex; flex-direction:column;
    }
    .leaflet-control-locate a {
      width:26px; height:26px;
      background:#fff; border:1px solid rgba(0,0,0,0.2);
      text-align:center; line-height:26px;
      color:#000; font-size:16px;
      display:flex; align-items:center; justify-content:center;
    }
    .leaflet-control-locate a:hover { background:#f4f4f4; }
    .leaflet-control-locate svg {
      width:14px; height:14px; display:block;
    }

    /* Position locate immediately above zoom */
    .leaflet-bottom.leaflet-right .leaflet-control-locate {
      margin-bottom: 58px; /* zoom control is ~52px tall, add spacing */
    }

    /* Splash overlay */
    #splash {
      position:fixed;inset:0;display:none;z-index:1500;
      background:#1A5EB2;
      color:#eef1f6;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      padding:32px;text-align:center;
    }
    #splash img {
      max-width:80%;height:auto;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.3);
    }
    #splash .tag { margin-top:24px;font-size: clamp(16px, 4.2vw, 36px); line-height:1.2; }
    #splash label { display:inline-flex;align-items:center;gap:8px;font-size:14px;opacity:0.9; }
  </style>
</head>
<body>
<div id="app">
  <div id="map"></div>

  <!-- Splash overlay with your graphic -->
  <div id="splash">
    <img src="./icons/splash-1284x2778.png" alt="FASTA splash"/>
    <div class="tag">your path,<br/>colored by <em>speed</em>.</div>
    <div style="margin-top:16px;">
      <label><input type="checkbox" id="dontShow"> Donâ€™t show again</label>
    </div>
    <div style="margin-top:12px;">
      <button id="dismissSplash" class="btn">Continue</button>
    </div>
  </div>

  <div id="toast"></div>
  <div id="build">FASTA v16 (splash image + polished locate)</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
(function(){
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }

  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    { maxZoom: 20, attribution: '&copy; OpenStreetMap', crossOrigin: 'anonymous' });

  const map = L.map('map',{zoomControl:true,layers:[osm]});
  map.setView([20,0],2);

  // Center on current location at startup (after splash)
  async function initAtLocation(){
    if(!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(
      pos=>{
        const {latitude,longitude} = pos.coords;
        map.setView([latitude,longitude], 16);
      },
      ()=>{},
      {enableHighAccuracy:true,timeout:8000}
    );
  }

  // Locate control styled like zoom
  const LocateControl = L.Control.extend({
    options: { position: 'bottomright' },
    onAdd: function() {
      const container = L.DomUtil.create('div','leaflet-control-locate leaflet-bar');
      const a = L.DomUtil.create('a','',container);
      a.href="#"; a.title="Center on my location";
      a.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="7"/>
        <line x1="12" y1="2" x2="12" y2="5"/>
        <line x1="12" y1="19" x2="12" y2="22"/>
        <line x1="2" y1="12" x2="5" y2="12"/>
        <line x1="19" y1="12" x2="22" y2="12"/>
        <circle cx="12" cy="12" r="2" fill="currentColor"/>
      </svg>`;
      L.DomEvent.on(a,'click', e=>{
        L.DomEvent.stop(e);
        if(!navigator.geolocation) return;
        navigator.geolocation.getCurrentPosition(
          pos=>{
            const {latitude,longitude}=pos.coords;
            map.flyTo([latitude,longitude], Math.max(map.getZoom(),16), {duration:0.6});
          },
          ()=>{},
          {enableHighAccuracy:true,timeout:10000}
        );
      });
      return container;
    }
  });
  map.addControl(new LocateControl());

  // Splash behavior
  const SPLASH_KEY='fasta_hide_splash';
  const splash=document.getElementById('splash'),
        dismissSplash=document.getElementById('dismissSplash'),
        dontShow=document.getElementById('dontShow');
  function maybeShowSplash(){
    if (localStorage.getItem(SPLASH_KEY) === '1') { initAtLocation(); return; }
    splash.style.display='flex';
  }
  dismissSplash.addEventListener('click', ()=>{
    if(dontShow.checked) localStorage.setItem(SPLASH_KEY,'1');
    splash.style.display='none';
    initAtLocation();
  });
  maybeShowSplash();
})();
</script>
</body>
</html>
